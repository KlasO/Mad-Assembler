; PokeyMax detect 2020/03/11: revision 0.14: Melody and POKEY-MAX support (preliminary)
; Mono/Tristesse

EOL = $9B

POKEYMAX_BASE = $D200

POKEYMAX_CONFIG_BASE = $D210

POKEYMAX_SID_BASE = $D240

POKEYMAX_MODE = $00
POKEYMAX_SATURATE_LINEAR = %00000000
POKEYMAX_SATURATE_POKEY = %00000001
POKEYMAX_SEPARATE_CHIP = %00000000
POKEYMAX_SEPARATE_CHANNEL = %00000100
POKEYMAX_IRQ_ONE = %00000000
POKEYMAX_IRQ_ALL = %00001000
POKEYMAX_MONO_FIXED = %00000000
POKEYMAX_MONO_DETECTION = %00010000
POKEYMAX_CLOCK_NTSC = %00000000
POKEYMAX_CLOCK_PAL = %00100000
POKEYMAX_CLOCK_MASK = %00100000

POKEYMAX_CAPABILITY = $01
POKEYMAX_POKEY_SINGLE = %00000000
POKEYMAX_POKEY_STEREO = %00000001
POKEYMAX_POKEY_QUAD = %00000010
POKEYMAX_SID_PRESENT = %00000100
POKEYMAX_PSG_PRESENT = %00001000
POKEYMAX_COVOX_PRESENT = %00010000
POKEYMAX_SAMPLE_PRESENT = %00100000
POKEYMAX_FLASH_PRESENT = %01000000

POKEYMAX_POSTDIVIDE = $02
POKEYMAX_DIV1 = %00000000
POKEYMAX_DIV2 = %00000001
POKEYMAX_DIV4 = %00000010
POKEYMAX_DIV8 = %00000011
POKEYMAX_DIVCH0 = 0
POKEYMAX_DIVCH1 = 2
POKEYMAX_DIVCH2 = 4
POKEYMAX_DIVCH3 = 6

POKEYMAX_GTIAEN = $03
POKEYMAX_GTIA0 = %00000001
POKEYMAX_GTIA1 = %00000010
POKEYMAX_GTIA2 = %00000100
POKEYMAX_GTIA3 = %00001000

POKEYMAX_VERSIONLOC = $04
POKEYMAX_VERSION = $04
; VRRDDDXX
; ::::::++-- chip configuration
; :::+++---- device signature
; :++------- firmware revision
; +--------- firmware version
; 105M02SA - stereo with auto control + GTIA in
; 105M02SU - stereo with Ultimate1MB control + GTIA in
; 105M02SC - stereo with COVOX + GTIA in
; 105M04QA - quad with auto control + GTIA in
; 105M04QC - quad with COVOX

POKEYMAX_PSGMODE = $05
POKEYMAX_PSGFREQ_2MHZ = %00000000
POKEYMAX_PSGFREQ_1MHZ = %00000001
POKEYMAX_PSGFREQ_BASE = %00000010
POKEYMAX_PSGSTEREO_MONO = %00000000
POKEYMAX_PSGSTEREO_ABC = %00000100
POKEYMAX_PSGSTEREO_ACB = %00001000
POKEYMAX_PSGSTEREO_CHIP = %00001100
POKEYMAX_PSGENV_32 = %00000000
POKEYMAX_PSGENV_16 = %00010000
POKEYMAX_PSGVOL_LOG = %00000000
POKEYMAX_PSGVOL_LINEAR = %01100000

POKEYMAX_SIDMODE = $06
POKEYMAX_SID1FILTER_8580 = %00000000
POKEYMAX_SID1FILTER_6581 = %00000001
POKEYMAX_SID1DIGIFIX_OFF = %00000000
POKEYMAX_SID1DIGIFIX_ON = %00000010
POKEYMAX_SID2FILTER_8580 = %00000000
POKEYMAX_SID2FILTER_6581 = %00010000
POKEYMAX_SID2DIGIFIX_OFF = %00000000
POKEYMAX_SID2DIGIFIX_ON = %00100000

POKEYMAX_RESTRICT = $07
;POKEYMAX_POKEY_SINGLE = %00000000
;POKEYMAX_POKEY_STEREO = %00000001
;POKEYMAX_POKEY_QUAD = %00000010
POKEYMAX_SID_ENABLE = %00000100
POKEYMAX_PSG_ENABLE = %00001000
POKEYMAX_COVOXSAMPLE_ENABLE = %00010000

POKEYMAX_ID = $0C
POKEYMAX_INSTALLED = %00000001

POKEYMAX_CONFIG = $0C
POKEYMAX_CFGDIS = %00000000
POKEYMAX_CFGEN = %00111111

POKEYMAX_FLASHOP = $0B
POKEYMAX_FLASH_WRITE = %00000000
POKEYMAX_FLASH_READ = %00000001
POKEYMAX_FLASH_REQ8 = %00000000
POKEYMAX_FLASH_REQ32 = %00000010
POKEYMAX_FLASH_ACCESS_DATA = %00000000
POKEYMAX_FLASH_ACCESS_CONFIG = %00000100
POKEYMAX_FLASH_A14 = %00111000

POKEYMAX_FLASHADL = $0D
POKEYMAX_FLASH_A0 = %11111100
POKEYMAX_FLASH_WIN = %00000011
POKEYMAX_FLASHADH = $0E
POKEYMAX_FLASHDAT = $0F

	org $2000

; Detect PokeyMAX device
detectpokeymax:
        lda POKEYMAX_BASE+POKEYMAX_ID
        cmp #POKEYMAX_INSTALLED
        bne ?no

        lda #%00111111          ;setup configuration bank in $D21x
        sta POKEYMAX_CONFIG_BASE+POKEYMAX_CONFIG

        lda POKEYMAX_CONFIG_BASE+POKEYMAX_CAPABILITY
        and #POKEYMAX_SID_PRESENT
        seq
        lda #%00000011
        sta pokeymaxdetected

        ldx #8-1
?loop   stx POKEYMAX_CONFIG_BASE+POKEYMAX_VERSIONLOC
        lda POKEYMAX_CONFIG_BASE+POKEYMAX_VERSION
        sta pokeymaxver,x
        dex
        bpl ?loop

        lda #%00000000          ;disable configuration bank in $D21x
        sta POKEYMAX_CONFIG_BASE+POKEYMAX_CONFIG

        lda pokeymaxdetected: #$00
        beq ?no

        jsr PRINTF
        .byte 'POKEYMAX %8s detected.',EOL
        .byte 0
        .word pokeymaxver
        rts

?no     jsr PRINTF
        .byte 'No POKEYMAX detected.',EOL
        .byte 0
        rts

; PokeyMAX version buffer
pokeymaxver .ds 8


	.link 'printf.obx'

